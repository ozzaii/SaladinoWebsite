{"version":3,"sources":["../src/loader/index.ts","../src/utils/getConfig.ts","../src/utils/formatValidate.ts","../src/utils/buildOutputInfo.ts"],"sourcesContent":["import path from 'node:path'\nimport fs from 'fs-extra'\nimport { PHASE_PRODUCTION_BUILD } from 'next/constants'\nimport loadConfig from 'next/dist/server/config'\nimport type { StaticImageData } from 'next/image'\nimport getConfig from 'src/utils/getConfig'\nimport type { LoaderContext } from 'webpack'\nimport type { Manifest } from '../cli'\nimport buildOutputInfo from '../utils/buildOutputInfo'\n\ntype LoaderOptions = {\n  dir: string\n  isServer: boolean\n  isDev: boolean\n}\n\nexport default async function loader(this: LoaderContext<LoaderOptions>, content: string) {\n  this.cacheable?.(false)\n  const callback = this.async()\n\n  const { dir, isDev } = this.getOptions()\n\n  if (isDev) {\n    callback(null, content)\n    return\n  }\n\n  const { src } = JSON.parse(content.replace(/^export default /, '').replace(/;$/, '')) as StaticImageData\n\n  const config = getConfig()\n\n  const nextConfig = await loadConfig(PHASE_PRODUCTION_BUILD, dir)\n  const allSizes = [...nextConfig.images.deviceSizes, ...nextConfig.images.imageSizes]\n\n  if (!src.endsWith('.svg')) {\n    await Promise.all(\n      allSizes.map(async (size) => {\n        const outputInfo = buildOutputInfo({ src, width: size, config })\n        for (const { output, src, extension } of outputInfo) {\n          const json: Manifest[number] = {\n            output: output,\n            src: src,\n            width: size,\n            extension: extension,\n          }\n\n          await fs.appendFile(\n            path.join(process.cwd(), '.next/next-export-optimize-images-list.nd.json'),\n            `${JSON.stringify(json)}\\n`\n          )\n        }\n      })\n    )\n  }\n\n  callback(null, content)\n  return\n}\n","import type { AvifOptions, JpegOptions, PngOptions, WebpOptions } from 'sharp'\nimport type { AllowedFormat } from './formatValidate'\n\ntype ParsedImageInfo = {\n  pathWithoutName: string\n  name: string\n  extension: string\n}\nexport type DefaultImageParser = (src: string) => ParsedImageInfo\ntype SourceImageParser = (determinerProps: { src: string; defaultParser: DefaultImageParser }) => ParsedImageInfo\n\nexport type Config = {\n  /**\n   * Specify if you are customizing the default output directory, such as next export -o outDir.\n   *\n   * @type {string}\n   */\n  outDir?: string\n  /**\n   * You can customize the directory to output optimized images.\n   * The default is '_next/static/chunks/images'.\n   *\n   * @type {string}\n   */\n  imageDir?: string\n  /**\n   * You can customize the directory to cache images.\n   * The default is 'node_modules/.cache'.\n   *\n   * @type {string}\n   */\n  cacheDir?: string\n  /**\n   * Images in the public directory are automatically optimized, but if there are any images you want to ignore the optimization for, please specify the path.\n   * Please specify a relative path from the public directory.\n   */\n  ignorePaths?: string[]\n  /**\n   * Required if you have set basePath in next.config.js.\n   * Please set the same value.\n   *\n   * @type {string}\n   */\n  basePath?: string\n  /**\n   * You can customize the directory to output downloaded external images.\n   * The default is '_next/static/media'\n   *\n   * @type {string}\n   */\n  externalImageDir?: string\n  /**\n   * You can customize the quality of the optimized image.\n   * The default is 75.\n   */\n  quality?: number\n  /**\n   * You can customize the generation of file names.\n   *\n   * ❗️Attention\n   * When making this setting, make sure that the file names (including the path part) of different images do not cover each other.\n   * Specifically, include the name, width, and extension in the return value. If path is not included, all src's should be specified with import or require so that they can be distinguished by their hash value even if they have the same filename.\n   *\n   * @type {({ path: string, name: string, width: number, extension: string }) => string}\n   */\n  filenameGenerator?: (generatorProps: { path: string; name: string; width: number; extension: string }) => string\n  /**\n   * You can set optimization options for each extension.\n   * Please refer to the official sharp documentation for more information.\n   *\n   * @type {{ png?: PngOptions, jpg?: JpegOptions, webp?: WebpOptions, avif?: AvifOptions } }}\n   */\n  sharpOptions?: {\n    png?: PngOptions\n    jpg?: JpegOptions\n    webp?: WebpOptions\n    avif?: AvifOptions\n  }\n  /**\n   * It allows you to convert images from any extension to another extension.\n   *\n   * @type {[beforeConvert: AllowedFormat, afterConvert: AllowedFormat][]}\n   */\n  convertFormat?: [beforeConvert: AllowedFormat, afterConvert: AllowedFormat][]\n\n  /**\n   * You can generate extra images in extensions specified.\n   * The default is ['webp'].\n   * This setting affects the extension displayed in the `Picture` component.\n   * The order is also important. For example, if `webp` is first, then `webp` will be displayed first.\n   *\n   * @type {('webp' | 'avif')[]}\n   */\n  generateFormats?: ('webp' | 'avif')[]\n\n  /**\n   * Allows you to optionally override the parsed image information before optimized images.\n   *\n   * @type {SourceImageParser}\n   */\n  sourceImageParser?: SourceImageParser\n\n  /**\n   * You can directly specify the URL of an external image.\n   * This is useful in cases where it is not known what images will be used for the build using variables, for example.\n   *\n   * @type {string[] | (() => string[] | Promise<string[]>)}\n   */\n  remoteImages?: string[] | (() => string[] | Promise<string[]>)\n\n  /**\n   * In case you need to download a large amount of images from an external CDN with a rate limit, this will add delays between downloading images.\n   */\n  remoteImagesDownloadsDelay?: number\n\n  /**\n   * You can specify the mode to use. The default is 'export'.\n   * 'build' mode is for use with `next build` and `next start`.\n   *\n   * @type {('build' | 'export')}\n   */\n  mode?: 'build' | 'export'\n}\n\ntype ResolvedConfig = Config & {\n  remoteImages?: string[]\n}\n\nconst getConfig = (): ResolvedConfig => {\n  // eslint-disable-next-line @typescript-eslint/no-var-requires\n  const config = require('next-export-optimize-images/export-images.config.js') as Omit<\n    ResolvedConfig,\n    'filenameGenerator' | 'sourceImageParser'\n  > & {\n    filenameGenerator?: string\n    sourceImageParser?: string\n  }\n\n  return {\n    ...config,\n    filenameGenerator: config.filenameGenerator\n      ? Function(`\"use strict\";return (${config.filenameGenerator})`)()\n      : undefined,\n    sourceImageParser: config.sourceImageParser\n      ? Function(`\"use strict\";return (${config.sourceImageParser})`)()\n      : undefined,\n  }\n}\n\nexport default getConfig\n","const formats = ['jpeg', 'jpg', 'png', 'webp', 'avif'] as const\nexport type AllowedFormat = (typeof formats)[number]\n\nconst formatValidate = (format?: string): format is AllowedFormat =>\n  formats.some((allowedFormat) => allowedFormat === format)\n\nexport default formatValidate\n","import formatValidate from './formatValidate'\nimport type { Config, DefaultImageParser } from './getConfig'\n\nexport const defaultImageParser: DefaultImageParser = (src: string) => {\n  const path = src.split(/\\.([^.]*$)/)[0]\n  const extension = (src.split(/\\.([^.]*$)/)[1] || '').split('?')[0]\n\n  if (!path || !extension) {\n    throw new Error(`Invalid path or no file extension: ${src}`)\n  }\n\n  let pathWithoutName = path.split('/').slice(0, -1).join('/')\n  const name = path.split('/').slice(-1).toString()\n\n  if (src.startsWith('http')) {\n    pathWithoutName = pathWithoutName\n      .replace(/^https?:\\/\\//, '')\n      .split('/')\n      .slice(1)\n      .join('/')\n  }\n\n  return {\n    pathWithoutName,\n    name,\n    extension,\n  }\n}\n\ntype BuildOutputInfoArgs = {\n  src: string\n  width: number\n  config: Config\n}\n\nconst buildOutputInfo = ({ src: _src, width, config }: BuildOutputInfoArgs) => {\n  let src = _src\n\n  if (config.basePath !== undefined) {\n    src = _src.replace(config.basePath, '')\n  }\n\n  const parsedImageInformation = config.sourceImageParser\n    ? config.sourceImageParser({ src, defaultParser: defaultImageParser })\n    : defaultImageParser(src)\n\n  let { extension } = parsedImageInformation\n  const { pathWithoutName, name, extension: originalExtension } = parsedImageInformation\n\n  if (config.convertFormat !== undefined) {\n    const convertArray = config.convertFormat.find(([beforeConvert]) => beforeConvert === extension)\n    if (convertArray !== undefined) {\n      if (!formatValidate(convertArray[0]))\n        throw Error(`Unauthorized format specified in \\`configFormat\\`. beforeConvert: ${convertArray[0]}`)\n      if (!formatValidate(convertArray[1]))\n        throw Error(`Unauthorized format specified in \\`configFormat\\`. afterConvert: ${convertArray[1]}`)\n\n      extension = convertArray[1]\n    }\n  }\n\n  const outputDir = `/${\n    config.imageDir ? config.imageDir.replace(/^\\//, '').replace(/\\/$/, '') : '_next/static/chunks/images'\n  }`\n\n  const extensions = [...new Set([...(config.generateFormats ?? ['webp']), extension])]\n  return extensions.map((extension, index) => {\n    if (extensions.length !== index + 1 && !formatValidate(extension))\n      throw Error(`Unauthorized extension specified in \\`generateFormats\\`: ${extension}`)\n\n    const filename =\n      config.filenameGenerator !== undefined\n        ? config.filenameGenerator({ path: pathWithoutName, name, width, extension })\n        : `${pathWithoutName}/${name}_${width}.${extension}`\n    const output = `${outputDir}/${filename.replace(/^\\//, '')}`\n\n    return { output, src, extension, originalExtension }\n  })\n}\n\nexport default buildOutputInfo\n"],"mappings":"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","names":["path","extension","loadConfig","src","fs","path"]}